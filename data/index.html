<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M5StickC WiFi Debug Tool</title>
    <style>
        :root {
            /* Светлая тема (по умолчанию) */
            --primary-color: #2196F3;
            --secondary-color: #0d47a1;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --error-color: #F44336;
            --bg-color: #f0f0f0;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: white;
            --tab-bg: #67baff;
            --tab-hover: #0061b0;
            --header-bg: var(--primary-color);
            --header-text: white;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1);
            --table-header-bg: #f2f2f2;
            --table-row-even: #f9f9f9;
            --table-row-hover: #f1f1f1;
            --disabled-color: #757575;
        }

        [data-theme="dark"] {
            /* Темная тема */
            --primary-color: #1976D2;
            --secondary-color: #1565C0;
            --success-color: #388E3C;
            --warning-color: #F57F17;
            --error-color: #C62828;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333333;
            --tab-active-bg: #1976D2;
            --tab-active-text: white;
            --tab-bg: #2c2c2c;
            --tab-hover: #3a3a3a;
            --header-bg: #1a1a1a;
            --header-text: white;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.2);
            --table-header-bg: #2a2a2a;
            --table-row-even: #262626;
            --table-row-hover: #333333;
            --disabled-color: #505050;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 5px 5px 0 0;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .device-info {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .device-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .device-info .indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .indicator.online {
            background-color: var(--success-color);
        }

        .indicator.offline {
            background-color: var(--error-color);
        }

        .tab {
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            border-radius: 5px 5px 0 0;
            display: flex;
            justify-content: center;
        }

        .tab button {
            background-color: var(--tab-bg);
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 16px;
            transition: 0.3s;
            font-size: 16px;
            border-radius: 5px 5px 0 0;
            color: var(--tab-active-text);
            flex: 1;
            text-align: center;
            max-width: 200px;
        }

        .tab button:hover {
            background-color: var(--tab-hover);
        }

        .tab button.active {
            background-color: var(--tab-active-bg);
            color: var(--tab-active-text);
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 5px 5px;
            background-color: var(--card-bg);
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .status-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid transparent;
        }

        .status-card.wifi {
            background-color: rgba(33, 150, 243, 0.1);
            border-left-color: var(--primary-color);
        }

        .status-card.ap {
            background-color: rgba(76, 175, 80, 0.1);
            border-left-color: var(--success-color);
        }

        .status-card h3 {
            margin: 0;
            font-size: 16px;
            color: var(--text-color);
        }

        .status-card.offline {
            background-color: rgba(244, 67, 54, 0.1);
            border-left-color: var(--error-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table, th, td {
            border: 1px solid var(--border-color);
        }

        th, td {
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: var(--table-header-bg);
            color: var(--text-color);
        }

        tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        tr:hover {
            background-color: var(--table-row-hover);
        }

        .network-list {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        input[type="text"], 
        input[type="password"], 
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        input[type="text"]:focus, 
        input[type="password"]:focus, 
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.25);
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button.secondary {
            background-color: var(--disabled-color);
        }

        button.secondary:hover {
            background-color: #616161;
        }

        button.success {
            background-color: var(--success-color);
        }

        button.success:hover {
            background-color: #388E3C;
        }

        button.warning {
            background-color: var(--warning-color);
            color: #333;
        }

        button.warning:hover {
            background-color: #FFA000;
        }

        button.danger {
            background-color: var(--error-color);
        }

        button.danger:hover {
            background-color: #D32F2F;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid transparent;
        }

        .status.info {
            background-color: rgba(33, 150, 243, 0.1);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
        }

        .status.success {
            background-color: rgba(76, 175, 80, 0.1);
            border-left-color: var(--success-color);
            color: var(--success-color);
        }

        .status.warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-left-color: var(--warning-color);
            color: var(--warning-color);
        }

        .status.error {
            background-color: rgba(244, 67, 54, 0.1);
            border-left-color: var(--error-color);
            color: var(--error-color);
        }

        .pin-card {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            transition: box-shadow 0.3s;
        }

        .pin-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .pin-info {
            flex-grow: 1;
        }

        .pin-state {
            width: 60px;
            text-align: center;
            font-weight: bold;
            color: var(--text-color);
        }

        .pin-state.on {
            color: var(--success-color);
        }

        .pin-state.off {
            color: var(--error-color);
        }

        .pin-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pulse-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pulse-control input[type="number"] {
            width: 80px;
            padding: 5px;
            font-size: 14px;
        }

        .pulse-button {
            background-color: var(--warning-color);
            color: #333;
            padding: 8px 12px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-btn {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }

        .toggle-btn input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 25px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 17px;
            width: 17px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(25px);
        }

        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .code-box {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin: 15px 0;
            font-family: "Courier New", monospace;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .badge.success {
            background-color: var(--success-color);
            color: white;
        }

        .badge.warning {
            background-color: var(--warning-color);
            color: #333;
        }

        .badge.error {
            background-color: var(--error-color);
            color: white;
        }

        .badge.secondary {
            background-color: var(--disabled-color);
            color: white;
        }

        .signal-strength {
            display: inline-block;
            width: 20px;
            height: 15px;
            position: relative;
        }

        .signal-bar {
            width: 4px;
            background-color: #ccc;
            position: absolute;
            bottom: 0;
            border-radius: 1px 1px 0 0;
        }

        .signal-bar.bar1 {
            height: 3px;
            left: 0px;
        }

        .signal-bar.bar2 {
            height: 6px;
            left: 6px;
        }

        .signal-bar.bar3 {
            height: 9px;
            left: 12px;
        }

        .signal-bar.bar4 {
            height: 12px;
            left: 18px;
        }

        .signal-excellent .signal-bar {
            background-color: var(--success-color);
        }

        .signal-good .signal-bar.bar1,
        .signal-good .signal-bar.bar2,
        .signal-good .signal-bar.bar3 {
            background-color: var(--success-color);
        }

        .signal-fair .signal-bar.bar1,
        .signal-fair .signal-bar.bar2 {
            background-color: var(--warning-color);
        }

        .signal-weak .signal-bar.bar1 {
            background-color: var(--error-color);
        }

        .flex-container {
            display: flex;
            gap: 20px;
        }

        .flex-column {
            display: flex;
            flex-direction: column;
        }

        .flex-grow {
            flex-grow: 1;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .align-center {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spacer {
            margin-top: 20px;
        }

        .divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 20px 0;
        }

        .text-center {
            text-align: center;
        }

        .progress-bar {
            height: 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress {
            height: 100%;
            background-color: var(--success-color);
            transition: width 0.3s;
        }

        .notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.3s forwards;
            max-width: 300px;
        }

        .notification.success {
            background-color: var(--success-color);
            color: white;
        }

        .notification.error {
            background-color: var(--error-color);
            color: white;
        }

        .notification.info {
            background-color: var(--primary-color);
            color: white;
        }

        .notification.warning {
            background-color: var(--warning-color);
            color: #333;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 15px;
        }

        .pagination button {
            width: 30px;
            height: 30px;
            padding: 0;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Theme toggle button */
        .theme-toggle {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: transparent;
            border: 1px solid var(--header-text);
            color: var(--header-text);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Styles for AP Users interface */
        .ap-users-list {
            margin-bottom: 20px;
        }

        .ap-user-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ap-user-info {
            flex-grow: 1;
        }

        .ap-user-controls {
            display: flex;
            gap: 10px;
        }

        .traffic-display {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }
        
        [data-theme="dark"] .traffic-display {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .traffic-display .divider {
            margin: 10px 0;
            height: 1px;
            background-color: var(--border-color);
        }
        
        .traffic-display .packet-info {
            margin: 5px 0;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: 3px;
        }
        
        [data-theme="dark"] .traffic-display .packet-info {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .user-details-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .user-details-section.hidden {
            display: none;
        }

        /* Pulse animation for scanning indicator */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .scanning-indicator {
            animation: pulse 1.5s infinite ease-in-out;
            background-color: var(--warning-color);
            border-radius: 50%;
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 10px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .fade-out {
            animation: slideOut 0.3s forwards;
        }

        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .device-info {
                flex-wrap: wrap;
            }

            .tab button {
                padding: 10px;
                font-size: 14px;
                max-width: none;
            }

            .flex-container {
                flex-direction: column;
            }

            .grid-container {
                grid-template-columns: 1fr;
            }

            .pin-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .pin-state {
                width: 100%;
                text-align: left;
            }

            .pin-controls {
                width: 100%;
                flex-wrap: wrap;
            }

            .pulse-control {
                width: 100%;
            }

            .pulse-control input[type="number"] {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>M5StickC WiFi Debugger</h1>
            <div class="device-info">
                <span id="wifi-indicator">
                    <span class="indicator offline"></span>
                    WiFi
                </span>
                <span id="ap-indicator">
                    <span class="indicator offline"></span>
                    AP
                </span>
                <span id="battery-indicator">Батарея: ...</span>
                <button id="theme-toggle" class="theme-toggle">
                    <span id="theme-icon">🌙</span>
                    <span id="theme-text">Темная тема</span>
                </button>
            </div>
        </header>
        
        <div class="notification-area" id="notification-area">
            <!-- Уведомления будут добавляться динамически -->
        </div>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'status')">Статус</button>
            <button class="tablinks" onclick="openTab(event, 'wifi')">Wi-Fi</button>
            <button class="tablinks" onclick="openTab(event, 'ap')">Точка доступа</button>
            <button class="tablinks" onclick="openTab(event, 'kvm')">KVM</button>
            <button class="tablinks" onclick="openTab(event, 'device')">Устройство</button>
            <button class="tablinks" onclick="openTab(event, 'network')">Сеть</button>
        </div>
        
        <!-- Вкладка статуса -->
        <div id="status" class="tabcontent" style="display: block;">
            <h2>Текущий статус</h2>
            
            <div id="wifi-status" class="status-card wifi offline">
                <div>
                    <h3>Статус WiFi</h3>
                    <div id="wifi-details">Загрузка...</div>
                </div>
            </div>
            
            <div id="ap-status" class="status-card ap offline">
                <div>
                    <h3>Статус точки доступа</h3>
                    <div id="ap-details">Загрузка...</div>
                </div>
            </div>
            
            <div class="card">
                <h3>Информация об устройстве</h3>
                <div class="flex-container">
                    <div class="flex-column flex-grow">
                        <p><strong>Устройство:</strong> M5StickC PLUS2</p>
                        <p><strong>Режим:</strong> <span id="operation-mode">Загрузка...</span></p>
                        <p><strong>IP-адрес:</strong> <span id="ip-address">-</span></p>
                    </div>
                    <div class="flex-column flex-grow">
                        <p>
                            <strong>Уровень сигнала:</strong> 
                            <span id="signal-strength-container">
                                <span id="signal-strength-text">-</span>
                                <span id="signal-strength-indicator" class="signal-strength">
                                    <span class="signal-bar bar1"></span>
                                    <span class="signal-bar bar2"></span>
                                    <span class="signal-bar bar3"></span>
                                    <span class="signal-bar bar4"></span>
                                </span>
                            </span>
                        </p>
                        <p><strong>Батарея:</strong> <span id="battery-level">-</span></p>
                        <div id="battery-indicator-bar" class="progress-bar">
                            <div id="battery-progress" class="progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="spacer">
                <button onclick="refreshStatus()" class="primary">Обновить статус</button>
            </div>
        </div>
        
        <!-- Вкладка Wi-Fi -->
        <div id="wifi" class="tabcontent">
            <h2>Управление Wi-Fi</h2>
            
            <div class="card">
                <div class="form-group">
                    <button id="scan-wifi-btn" onclick="scanNetworks()" class="primary">Сканировать сети</button>
                    <div class="loader" id="scan-loader"></div>
                    <div id="scan-status" style="margin-top: 10px; display: none;">
                        <span class="scanning-indicator"></span>
                        <span id="scan-status-text">Сканирование...</span>
                    </div>
                </div>
                
                <div class="network-list">
                    <table id="networks-table">
                        <thead>
                            <tr>
                                <th>SSID</th>
                                <th>Сигнал</th>
                                <th>Безопасность</th>
                                <th>Канал</th>
                                <th>Действие</th>
                            </tr>
                        </thead>
                        <tbody id="networks-list">
                            <tr>
                                <td colspan="5" class="text-center">Нажмите "Сканировать сети" для поиска доступных WiFi сетей</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3>Подключение к сети</h3>
                <form id="connect-form">
                    <div class="form-group">
                        <label for="ssid">SSID:</label>
                        <input type="text" id="ssid" name="ssid" placeholder="Введите имя сети" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Пароль:</label>
                        <input type="password" id="password" name="password" placeholder="Введите пароль сети">
                    </div>
                    
                    <button type="submit" class="success">Подключиться</button>
                </form>
            </div>
            
            <div class="card">
                <h3>Сохраненные сети</h3>
                <div id="saved-networks-list">
                    <p class="text-center">Загрузка сохраненных сетей...</p>
                </div>
                <div class="spacer">
                    <button onclick="loadSavedNetworks()" class="primary">Обновить список</button>
                </div>
            </div>
        </div>
        
        <!-- Вкладка точки доступа -->
        <div id="ap" class="tabcontent">
            <h2>Настройки точки доступа</h2>
            
            <div class="card">
                <form id="ap-form">
                    <div class="form-group">
                        <label for="ap-mode">Режим:</label>
                        <select id="ap-mode" name="mode">
                            <option value="0">Выключено</option>
                            <option value="1">Обычный</option>
                            <option value="2">Ретранслятор</option>
                            <option value="3">Скрытый</option>
                            <option value="4">Honeypot</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ap-ssid">SSID:</label>
                        <input type="text" id="ap-ssid" name="ssid" placeholder="Введите имя точки доступа">
                    </div>
                    
                    <div class="form-group">
                        <label for="ap-password">Пароль:</label>
                        <input type="password" id="ap-password" name="password" placeholder="Введите пароль точки доступа">
                    </div>
                    
                    <div class="form-group">
                        <label for="ap-channel">Канал:</label>
                        <select id="ap-channel" name="channel">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="success">Применить</button>
                </form>
            </div>
            
            <div class="card">
                <h3>Подключенные пользователи</h3>
                <div id="ap-users-list" class="ap-users-list">
                    <p class="text-center">Загрузка списка пользователей...</p>
                </div>
                <div class="spacer">
                    <button onclick="loadAPUsers()" class="primary">Обновить список</button>
                </div>
            </div>
            
            <div id="honeypot-section" class="card" style="display: none; margin-top: 20px;">
                <h3>Логи Honeypot</h3>
                <button onclick="getHoneypotLogs()" class="primary">Обновить логи</button>
                
                <div id="honeypot-logs" class="spacer">
                    <p>Нет записей</p>
                </div>
            </div>
        </div>
        
        <!-- Вкладка KVM -->
        <div id="kvm" class="tabcontent">
            <h2>Управление KVM</h2>
            
            <div class="card">
                <h3>Настроенные пины</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="invert-pins" onchange="togglePinInversion()">
                        Инвертировать логику пинов (0 = ВКЛ, 1 = ВЫКЛ)
                    </label>
                </div>
                <div id="pins-list">
                    <!-- Список пинов будет загружен динамически -->
                    <p class="text-center">Загрузка пинов...</p>
                </div>
            </div>
            
            <div class="card">
                <h3>Добавить новый пин</h3>
                <form id="add-pin-form">
                    <div class="form-group">
                        <label for="pin-select">Выберите пин:</label>
                        <select id="pin-select" name="pin" required>
                            <option value="">-- Выберите пин --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pin-name">Название:</label>
                        <input type="text" id="pin-name" name="name" placeholder="Введите название пина" required>
                    </div>
                    
                    <button type="submit" class="success">Добавить пин</button>
                </form>
            </div>
            
            <div class="card">
                <h3>Настройки мониторинга</h3>
                <form id="connection-check-form">
                    <div class="form-group">
                        <label for="connection-check">Интервал проверки соединения:</label>
                        <select id="connection-check" name="interval">
                            <option value="0">Выключен</option>
                            <option value="1">10 секунд</option>
                            <option value="2">30 секунд</option>
                            <option value="3">1 минута</option>
                            <option value="4">5 минут</option>
                            <option value="5">30 минут</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="success">Сохранить</button>
                </form>
            </div>
            
            <div class="card">
                <h3>API для управления через curl</h3>
                <div class="code-box">
# Включение пина
curl -X POST "http://{IP-адрес}/api/kvm/pin?index=0&state=1"

# Выключение пина
curl -X POST "http://{IP-адрес}/api/kvm/pin?index=0&state=0"

# Переключение пина
curl -X POST "http://{IP-адрес}/api/kvm/pin?index=0"

# Отправка импульса на пин
curl -X POST "http://{IP-адрес}/api/kvm/pulse?index=0&duration=500"
                </div>
            </div>
        </div>
        
        <!-- Вкладка устройства -->
        <div id="device" class="tabcontent">
            <h2>Информация об устройстве</h2>
            
            <div class="card">
                <div id="device-details">
                    <p class="text-center">Загрузка информации...</p>
                </div>
            </div>
            
            <div class="card">
                <h3>Действия</h3>
                <div class="flex-container">
                    <button onclick="findMe()" class="primary">Найти устройство</button>
                    <button onclick="resetDevice()" class="warning">Перезагрузить устройство</button>
                </div>
                <p><small>Функция "Найти устройство" активирует звуковой сигнал на устройстве</small></p>
            </div>
            
            <div class="card">
                <h3>Настройки устройства</h3>
                <form id="device-settings-form">
                    <div class="form-group">
                        <label for="brightness">Яркость экрана:</label>
                        <input type="range" id="brightness" name="brightness" min="0" max="100" value="80">
                        <span id="brightness-value">80%</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="sleep-timeout">Время до перехода в спящий режим:</label>
                        <select id="sleep-timeout" name="sleepTimeout">
                            <option value="0">Выключено</option>
                            <option value="30">30 секунд</option>
                            <option value="60">1 минута</option>
                            <option value="120">2 минуты</option>
                            <option value="300">5 минут</option>
                            <option value="600">10 минут</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="device-id">Идентификатор устройства:</label>
                        <input type="text" id="device-id" name="deviceId" placeholder="Введите идентификатор устройства">
                    </div>
                    
                    <div class="form-group">
                        <label>Поворот экрана:</label>
                        <div class="align-center">
                            <input type="checkbox" id="rotate-display" name="rotateDisplay">
                            <label for="rotate-display" style="display: inline; margin-bottom: 0;">Включить поворот экрана</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="volume">Громкость:</label>
                        <input type="range" id="volume" name="volume" min="0" max="100" value="70">
                        <span id="volume-value">70%</span>
                    </div>
                    
                    <button type="submit" class="success">Сохранить настройки</button>
                </form>
            </div>
        </div>
        
        <!-- Вкладка сетевых инструментов -->
        <div id="network" class="tabcontent">
            <h2>Сетевые инструменты</h2>
            
            <div class="card">
                <h3>Ping</h3>
                <form id="ping-form">
                    <div class="form-group">
                        <label for="ping-host">Хост/IP:</label>
                        <input type="text" id="ping-host" name="host" placeholder="Например: 8.8.8.8" required>
                    </div>
                    
                    <button type="submit" class="primary">Ping</button>
                </form>
                <div id="ping-result" class="spacer"></div>
            </div>
            
            <div class="card">
                <h3>Сканирование IP-адресов</h3>
                <form id="ip-scan-form">
                    <div class="form-group">
                        <label for="ip-prefix">Префикс сети:</label>
                        <input type="text" id="ip-prefix" name="prefix" placeholder="192.168.1" required>
                    </div>
                    
                    <button type="submit" class="primary">Сканировать</button>
                </form>
                <div id="ip-scan-progress" style="display: none;">
                    <div class="progress-bar">
                        <div id="ip-scan-progress-bar" class="progress" style="width: 0%"></div>
                    </div>
                    <p id="ip-scan-status">Сканирование: 0/254</p>
                </div>
                <div id="ip-scan-result" class="spacer"></div>
            </div>
            
            <div class="card">
                <h3>Сканирование портов</h3>
                <form id="port-scan-form">
                    <div class="form-group">
                        <label for="port-scan-ip">IP-адрес:</label>
                        <input type="text" id="port-scan-ip" name="ip" placeholder="Например: 192.168.1.1" required>
                    </div>
                    
                    <div class="flex-container">
                        <div class="form-group flex-grow">
                            <label for="port-scan-start">Начальный порт:</label>
                            <input type="number" id="port-scan-start" name="startPort" value="1" min="1" max="65535" required>
                        </div>
                        
                        <div class="form-group flex-grow">
                            <label for="port-scan-end">Конечный порт:</label>
                            <input type="number" id="port-scan-end" name="endPort" value="1024" min="1" max="65535" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="primary">Сканировать порты</button>
                </form>
                <div id="port-scan-result" class="spacer"></div>
            </div>
            
            <div id="ip-block-section" class="card">
                <h3>Блокировка IP (только для режима AP)</h3>
                <form id="ip-block-form">
                    <div class="form-group">
                        <label for="block-ip">IP для блокировки:</label>
                        <input type="text" id="block-ip" name="ip" placeholder="Например: 192.168.4.2" required>
                    </div>
                    
                    <button type="submit" class="danger">Заблокировать</button>
                </form>
                <div class="spacer">
                    <h4>Заблокированные IP-адреса</h4>
                    <div id="blocked-ips">
                        <p>Нет заблокированных IP-адресов</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Глобальные переменные
        let currentMode = '';
        let isAPModeActive = false;
        let isPinInverted = false;
        let currentUserIP = null;
        let sniffInterval = null;
        
        // Функция для загрузки доступных пинов
        function loadAvailablePins() {
            fetch('/api/kvm/available-pins')
                .then(response => response.json())
                .then(data => {
                    const pinSelect = document.getElementById('pin-select');
                    // Очищаем текущий список
                    while (pinSelect.options.length > 1) {
                        pinSelect.remove(1);
                    }
                    
                    data.pins.forEach(pin => {
                        const option = document.createElement('option');
                        option.value = pin.pin;
                        option.textContent = `${pin.name} - ${pin.description}`;
                        option.disabled = pin.inUse; // Отключаем уже используемые пины
                        if (pin.inUse) {
                            option.textContent += ' (В использовании)';
                        }
                        pinSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке доступных пинов:', error);
                    showNotification('Ошибка при загрузке списка пинов', 'error');
                });
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Применяем сохраненную тему
            applyTheme();
            
            refreshStatus();
            loadKVMPins();
            loadAvailablePins(); // Добавляем загрузку доступных пинов
            loadAPSettings();
            loadDeviceSettings();
            loadSavedNetworks();
            loadAPUsers();
            
            // Настройка обработчика для темы
            document.getElementById('theme-toggle').addEventListener('click', function() {
                toggleTheme();
            });
            
            // Настройка обработчиков для ползунков
            document.getElementById('brightness').addEventListener('input', function() {
                document.getElementById('brightness-value').textContent = this.value + '%';
            });
            
            document.getElementById('volume').addEventListener('input', function() {
                document.getElementById('volume-value').textContent = this.value + '%';
            });
            
            // Настройка обработчиков форм
            document.getElementById('connect-form').addEventListener('submit', function(e) {
                e.preventDefault();
                connectToNetwork();
            });
            
            document.getElementById('add-pin-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewPin();
            });
            
            document.getElementById('ap-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateAPSettings();
            });
            
            document.getElementById('connection-check-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateConnectionCheck();
            });
            
            document.getElementById('ping-form').addEventListener('submit', function(e) {
                e.preventDefault();
                pingHost();
            });
            
            document.getElementById('ip-scan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                scanIPRange();
            });
            
            document.getElementById('port-scan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                scanPorts();
            });
            
            document.getElementById('ip-block-form').addEventListener('submit', function(e) {
                e.preventDefault();
                blockIP();
            });
            
            document.getElementById('device-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDeviceSettings();
            });
            
            // Обработчик выбора режима AP
            document.getElementById('ap-mode').addEventListener('change', function(e) {
                const honeypotSection = document.getElementById('honeypot-section');
                if (e.target.value === '4') { // Honeypot mode
                    honeypotSection.style.display = 'block';
                } else {
                    honeypotSection.style.display = 'none';
                }
            });
            
            // Загружаем статус инвертирования пинов
            fetch('/settings/pin-inversion')
                .then(response => response.json())
                .then(data => {
                    isPinInverted = data.inverted;
                    document.getElementById('invert-pins').checked = isPinInverted;
                })
                .catch(error => {
                    console.error('Ошибка при загрузке настроек инвертирования пинов:', error);
                });
            
            // Периодическое обновление статуса
            setInterval(refreshStatus, 30000); // Обновление каждые 30 секунд
        });

        // Функция переключения темы
        function toggleTheme() {
            const theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Обновляем иконку и текст кнопки
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (theme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Светлая тема';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Темная тема';
            }
        }
        
        // Функция применения темы
        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            // Обновляем иконку и текст кнопки
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (savedTheme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Светлая тема';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Темная тема';
            }
        }
        
        // Функция для отправки импульса на пин
        function sendPulseToPin(pinIndex, duration) {
            if (!duration) {
                duration = document.querySelector(`#pin-pulse-duration-${pinIndex}`).value;
            }
            
            fetch('/api/kvm/pulse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `index=${pinIndex}&duration=${duration}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Импульс отправлен на пин (длительность: ${duration} мс)`, 'success');
                } else {
                    showNotification(`Ошибка отправки импульса: ${data.message || 'Неизвестная ошибка'}`, 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при отправке импульса на пин:', error);
                showNotification('Ошибка при отправке импульса на пин', 'error');
            });
        }
        
        // Функция переключения режима инвертирования пинов
        function togglePinInversion() {
            const inverted = document.getElementById('invert-pins').checked;
            
            fetch('/settings/pin-inversion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `inverted=${inverted ? 1 : 0}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isPinInverted = inverted;
                    showNotification(`Режим инвертирования пинов ${inverted ? 'включен' : 'выключен'}`, 'success');
                    loadKVMPins(); // Перезагружаем пины для обновления отображения
                } else {
                    showNotification('Ошибка изменения режима инвертирования', 'error');
                    // Возвращаем состояние чекбокса
                    document.getElementById('invert-pins').checked = isPinInverted;
                }
            })
            .catch(error => {
                console.error('Ошибка при изменении режима инвертирования пинов:', error);
                showNotification('Ошибка при изменении режима инвертирования пинов', 'error');
                // Возвращаем состояние чекбокса
                document.getElementById('invert-pins').checked = isPinInverted;
            });
        }
        
        // Функция загрузки сохраненных сетей
        function loadSavedNetworks() {
            const savedNetworksList = document.getElementById('saved-networks-list');
            savedNetworksList.innerHTML = '<p class="text-center">Загрузка сохраненных сетей...</p>';
            
            fetch('/wifi/saved')
                .then(response => response.json())
                .then(data => {
                    if (data.networks && data.networks.length > 0) {
                        let html = '<table>';
                        html += '<thead><tr><th>SSID</th><th>Действия</th></tr></thead><tbody>';
                        
                        data.networks.forEach(network => {
                            html += `<tr>
                                <td>${network.ssid}</td>
                                <td>
                                    <button onclick="connectToSavedNetwork('${network.ssid}')" class="success">Подключиться</button>
                                    <button onclick="deleteSavedNetwork('${network.ssid}')" class="danger">Удалить</button>
                                </td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table>';
                        savedNetworksList.innerHTML = html;
                    } else {
                        savedNetworksList.innerHTML = '<p class="text-center">Нет сохраненных сетей</p>';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке сохраненных сетей:', error);
                    savedNetworksList.innerHTML = '<p class="text-center">Ошибка при загрузке сохраненных сетей</p>';
                    showNotification('Ошибка при загрузке сохраненных сетей', 'error');
                });
        }
        
        // Функция подключения к сохраненной сети
        function connectToSavedNetwork(ssid) {
            showNotification(`Подключение к сети ${ssid}...`, 'info');
            
            fetch('/wifi/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ssid=${encodeURIComponent(ssid)}`
            })
            .then(response => response.text())
            .then(result => {
                showNotification(`Подключение к сети ${ssid} инициировано`, 'success');
                
                // Ждем некоторое время и обновляем статус
                setTimeout(refreshStatus, 5000);
            })
            .catch(error => {
                console.error('Ошибка при подключении к сохраненной сети:', error);
                showNotification('Ошибка при подключении к сохраненной сети', 'error');
            });
        }
        
        // Функция удаления сохраненной сети
        function deleteSavedNetwork(ssid) {
            if (confirm(`Вы уверены, что хотите удалить сеть "${ssid}"?`)) {
                fetch('/wifi/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `ssid=${encodeURIComponent(ssid)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Сеть ${ssid} удалена`, 'success');
                        loadSavedNetworks();
                    } else {
                        showNotification(`Ошибка удаления сети: ${data.message || 'Неизвестная ошибка'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Ошибка при удалении сохраненной сети:', error);
                    showNotification('Ошибка при удалении сохраненной сети', 'error');
                });
            }
        }
        
        // Функция для показа уведомлений
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            notificationArea.appendChild(notification);
            
            // Удаляем уведомление через 5 секунд
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }
        
        // Функция для открытия вкладки
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            
            // Скрываем все вкладки
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Убираем активный класс у всех кнопок
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            // Показываем выбранную вкладку и делаем кнопку активной
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // Обновляем данные на вкладках при переключении
            if (tabName === 'status') {
                refreshStatus();
            } else if (tabName === 'kvm') {
                loadKVMPins();
                loadAvailablePins();
            } else if (tabName === 'ap') {
                loadAPSettings();
                loadAPUsers();
            } else if (tabName === 'device') {
                loadDeviceSettings();
                loadDeviceInfo();
            } else if (tabName === 'network') {
                checkNetworkTools();
            } else if (tabName === 'wifi') {
                loadSavedNetworks();
            }
        }
        
        // Функция для обновления статуса
        function refreshStatus() {
            fetch('/diagnostic')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    // Обновляем информацию о статусе WiFi
                    const wifiStatus = document.getElementById('wifi-status');
                    const wifiDetails = document.getElementById('wifi-details');
                    const ipAddress = document.getElementById('ip-address');
                    const signalStrength = document.getElementById('signal-strength-text');
                    const signalIndicator = document.getElementById('signal-strength-indicator');
                    const operationMode = document.getElementById('operation-mode');
                    const batteryLevel = document.getElementById('battery-level');
                    const wifiIndicator = document.getElementById('wifi-indicator').querySelector('.indicator');
                    
                    if (data.connected) {
                        wifiStatus.classList.remove('offline');
                        wifiIndicator.classList.remove('offline');
                        wifiIndicator.classList.add('online');
                        
                        wifiDetails.innerHTML = `Подключено к сети: <strong>${data.ssid}</strong><br>Уровень сигнала: ${data.rssi} dBm`;
                        ipAddress.textContent = data.ip;
                        signalStrength.textContent = `${data.rssi} dBm`;
                        
                        // Обновляем индикатор сигнала
                        signalIndicator.className = 'signal-strength';
                        if (data.rssi > -50) {
                            signalIndicator.classList.add('signal-excellent');
                        } else if (data.rssi > -70) {
                            signalIndicator.classList.add('signal-good');
                        } else if (data.rssi > -80) {
                            signalIndicator.classList.add('signal-fair');
                        } else {
                            signalIndicator.classList.add('signal-weak');
                        }
                        
                        operationMode.textContent = 'Клиент';
                        operationMode.className = 'badge success';
                        currentMode = 'client';
                    } else {
                        wifiStatus.classList.add('offline');
                        wifiIndicator.classList.remove('online');
                        wifiIndicator.classList.add('offline');
                        
                        wifiDetails.innerHTML = '<strong>Не подключено к WiFi</strong>';
                        ipAddress.textContent = '-';
                        signalStrength.textContent = '-';
                        signalIndicator.className = 'signal-strength';
                        operationMode.textContent = 'Неизвестно';
                        operationMode.className = '';
                        currentMode = 'unknown';
                    }
                    
                    // Обновляем информацию о точке доступа
                    const apStatus = document.getElementById('ap-status');
                    const apDetails = document.getElementById('ap-details');
                    const apIndicator = document.getElementById('ap-indicator').querySelector('.indicator');
                    
                    if (data.ap_mode !== undefined && data.ap_mode > 0) {
                        apStatus.classList.remove('offline');
                        apIndicator.classList.remove('offline');
                        apIndicator.classList.add('online');
                        
                        let apModeName = 'Неизвестно';
                        switch(data.ap_mode) {
                            case 1: apModeName = 'Обычный'; break;
                            case 2: apModeName = 'Ретранслятор'; break;
                            case 3: apModeName = 'Скрытый'; break;
                            case 4: apModeName = 'Honeypot'; break;
                        }
                        
                        apDetails.innerHTML = `
                            Режим: <strong>${apModeName}</strong><br>
                            SSID: <strong>${data.ap_ssid}</strong><br>
                            IP: ${data.ap_ip}<br>
                            Подключено клиентов: ${data.ap_stations}
                        `;
                        
                        isAPModeActive = true;
                        
                        // Если мы в режиме AP, обновляем кнопку блокировки IP
                        document.getElementById('ip-block-section').style.display = 'block';
                        loadBlockedIPs();
                    } else {
                        apStatus.classList.add('offline');
                        apIndicator.classList.remove('online');
                        apIndicator.classList.add('offline');
                        
                        apDetails.innerHTML = '<strong>Точка доступа выключена</strong>';
                        isAPModeActive = false;
                        
                        // Скрываем секцию блокировки IP, если AP не активен
                        document.getElementById('ip-block-section').style.display = 'none';
                    }
                    
                    // Обновляем информацию о батарее
                    if (data.battery) {
                        const batteryVoltage = data.battery.toFixed(2);
                        batteryLevel.textContent = `${batteryVoltage}V`;
                        document.getElementById('battery-indicator').textContent = `Батарея: ${batteryVoltage}V`;
                        
                        // Расчет примерного процента заряда (для M5StickC PLUS 2)
                        // 4.2V - 100%, 3.0V - 0%
                        let batteryPercent = Math.min(100, Math.max(0, (data.battery - 3.0) / 1.2 * 100));
                        document.getElementById('battery-progress').style.width = batteryPercent.toFixed(0) + '%';
                        
                        // Меняем цвет индикатора в зависимости от заряда
                        if (batteryPercent < 20) {
                            document.getElementById('battery-progress').style.backgroundColor = 'var(--error-color)';
                        } else if (batteryPercent < 50) {
                            document.getElementById('battery-progress').style.backgroundColor = 'var(--warning-color)';
                        } else {
                            document.getElementById('battery-progress').style.backgroundColor = 'var(--success-color)';
                        }
                    }
                })
                .catch(error => {
                    console.error('Ошибка при обновлении статуса:', error);
                    showNotification('Ошибка при обновлении статуса: ' + error.message, 'error');
                });
        }
        
        // Функция для сканирования сетей с улучшенным отслеживанием статуса
        function scanNetworks() {
            // Показываем индикатор сканирования
            const scanButton = document.getElementById('scan-wifi-btn');
            const scanStatus = document.getElementById('scan-status');
            const scanStatusText = document.getElementById('scan-status-text');
            
            scanButton.disabled = true;
            scanStatus.style.display = 'block';
            scanStatusText.textContent = 'Сканирование...';
            
            // Очищаем текущий список
            const networksList = document.getElementById('networks-list');
            networksList.innerHTML = '<tr><td colspan="5" class="text-center">Запуск сканирования...</td></tr>';
            
            // Сначала запускаем сканирование
            fetch('/scan-start')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    networksList.innerHTML = '<tr><td colspan="5" class="text-center">Сканирование выполняется...</td></tr>';
                    scanStatusText.textContent = 'Сканирование выполняется...';
                    
                    // Функция для проверки статуса сканирования
                    function checkScanStatus() {
                        fetch('/scan-status')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Ошибка сети');
                                }
                                return response.json();
                            })
                            .then(statusData => {
                                if (statusData.status === 'scanning') {
                                    // Если сканирование всё еще идет, проверяем снова через 1 секунду
                                    scanStatusText.textContent = 'Сканирование выполняется...';
                                    setTimeout(checkScanStatus, 1000);
                                } else if (statusData.status === 'ready') {
                                    // Если сканирование завершено, запрашиваем результаты
                                    scanStatusText.textContent = 'Загрузка результатов...';
                                    getNetworkResults();
                                } else {
                                    // Неожиданный статус
                                    networksList.innerHTML = '<tr><td colspan="5" class="text-center">Ошибка: Неожиданный статус сканирования</td></tr>';
                                    scanButton.disabled = false;
                                    scanStatus.style.display = 'none';
                                    showNotification('Ошибка: Неожиданный статус сканирования', 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Ошибка при проверке статуса сканирования:', error);
                                networksList.innerHTML = '<tr><td colspan="5" class="text-center">Ошибка при проверке статуса сканирования</td></tr>';
                                scanButton.disabled = false;
                                scanStatus.style.display = 'none';
                                showNotification('Ошибка при проверке статуса сканирования: ' + error.message, 'error');
                            });
                    }
                    
                    // Начинаем проверять статус
                    if (data.status === 'started' || data.status === 'scanning') {
                        setTimeout(checkScanStatus, 1000);
                    } else if (data.status === 'ready') {
                        // Если результаты уже готовы, запрашиваем их сразу
                        getNetworkResults();
                    }
                })
                .catch(error => {
                    console.error('Ошибка при запуске сканирования:', error);
                    networksList.innerHTML = '<tr><td colspan="5" class="text-center">Ошибка при запуске сканирования</td></tr>';
                    scanButton.disabled = false;
                    scanStatus.style.display = 'none';
                    showNotification('Ошибка при запуске сканирования: ' + error.message, 'error');
                });
            
            // Функция для получения результатов сканирования
            function getNetworkResults() {
                fetch('/scan-results')
                    .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                    })
                    .then(data => {
                    // Обновляем список сетей
                    networksList.innerHTML = '';
                    
                    if (data.networks && data.networks.length > 0) {
                        data.networks.forEach(network => {
                        const row = document.createElement('tr');
                        
                        // SSID
                        const ssidCell = document.createElement('td');
                        ssidCell.textContent = network.ssid || '(Скрытая сеть)';
                        row.appendChild(ssidCell);
                        
                        // Сигнал с визуальным индикатором
                        const rssiCell = document.createElement('td');
                        const signalDiv = document.createElement('div');
                        signalDiv.className = 'align-center';
                        
                        const signalText = document.createElement('span');
                        signalText.textContent = `${network.rssi} dBm`;
                        
                        const signalIndicator = document.createElement('span');
                        signalIndicator.className = 'signal-strength';
                        
                        for (let i = 1; i <= 4; i++) {
                            const bar = document.createElement('span');
                            bar.className = `signal-bar bar${i}`;
                            signalIndicator.appendChild(bar);
                        }
                        
                        if (network.rssi > -50) {
                            signalIndicator.classList.add('signal-excellent');
                        } else if (network.rssi > -70) {
                            signalIndicator.classList.add('signal-good');
                        } else if (network.rssi > -80) {
                            signalIndicator.classList.add('signal-fair');
                        } else {
                            signalIndicator.classList.add('signal-weak');
                        }
                        
                        signalDiv.appendChild(signalText);
                        signalDiv.appendChild(signalIndicator);
                        rssiCell.appendChild(signalDiv);
                        row.appendChild(rssiCell);
                        
                        // Безопасность
                        const securityCell = document.createElement('td');
                        const securitySpan = document.createElement('span');
                        securitySpan.textContent = network.encryption;
                        
                        if (network.encryption === 'Open') {
                            securitySpan.className = 'badge warning';
                        } else {
                            securitySpan.className = 'badge success';
                        }
                        
                        securityCell.appendChild(securitySpan);
                        row.appendChild(securityCell);
                        
                        // Канал
                        const channelCell = document.createElement('td');
                        channelCell.textContent = network.channel;
                        row.appendChild(channelCell);
                        
                        // Кнопка подключения
                        const actionCell = document.createElement('td');
                        const connectBtn = document.createElement('button');
                        connectBtn.textContent = 'Подключиться';
                        connectBtn.className = 'primary';
                        connectBtn.addEventListener('click', function() {
                            // Заполняем форму подключения данными выбранной сети
                            document.getElementById('ssid').value = network.ssid;
                            document.getElementById('password').focus();
                            
                            // Прокручиваем до формы подключения
                            document.getElementById('connect-form').scrollIntoView({
                            behavior: 'smooth'
                            });
                        });
                        actionCell.appendChild(connectBtn);
                        row.appendChild(actionCell);
                        
                        networksList.appendChild(row);
                        });
                    } else {
                        networksList.innerHTML = '<tr><td colspan="5" class="text-center">Сети не найдены</td></tr>';
                    }
                    
                    // Обновляем статус
                    scanButton.disabled = false;
                    scanStatus.style.display = 'none';
                    showNotification('Сканирование WiFi сетей завершено', 'success');
                    })
                    .catch(error => {
                    // Отображаем ошибку
                    networksList.innerHTML = '<tr><td colspan="5" class="text-center">Ошибка при получении результатов сканирования</td></tr>';
                    console.error('Ошибка при получении результатов сканирования:', error);
                    scanButton.disabled = false;
                    scanStatus.style.display = 'none';
                    showNotification('Ошибка при получении результатов сканирования: ' + error.message, 'error');
                    });
            }            
            
            // Функция для загрузки конкретной страницы результатов
            function loadNetworkPage(page) {
                scanButton.disabled = true;
                scanStatus.style.display = 'block';
                scanStatusText.textContent = 'Загрузка страницы ' + (page + 1) + '...';
                
                networksList.innerHTML = '<tr><td colspan="5" class="text-center">Загрузка страницы ' + (page + 1) + '...</td></tr>';
                
                fetch(`/scan-results?page=${page}&size=10`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Ошибка сети');
                        }
                        return response.json();
                    })
                    .then(data => {
                        getNetworkResults();
                    })
                    .catch(error => {
                        networksList.innerHTML = '<tr><td colspan="5" class="text-center">Ошибка при загрузке страницы</td></tr>';
                        console.error('Ошибка при загрузке страницы:', error);
                        scanButton.disabled = false;
                        scanStatus.style.display = 'none';
                        showNotification('Ошибка при загрузке страницы: ' + error.message, 'error');
                    });
            }
        }
        
        // Функция для подключения к сети
        function connectToNetwork() {
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;
            
            if (!ssid) {
                showNotification('Введите SSID сети', 'warning');
                return;
            }
            
            showNotification(`Подключение к сети ${ssid}...`, 'info');
            
            const formData = new FormData();
            formData.append('ssid', ssid);
            formData.append('password', password);
            
            fetch('/connect', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                showNotification(`Подключение к сети ${ssid} инициировано`, 'success');
                
                // Очищаем форму
                document.getElementById('password').value = '';
                
                // Перезагружаем список сохраненных сетей
                setTimeout(() => {
                    loadSavedNetworks();
                    refreshStatus();
                }, 5000);
            })
            .catch(error => {
                console.error('Ошибка при подключении к сети:', error);
                showNotification('Ошибка при подключении к сети: ' + error.message, 'error');
            });
        }
        
        // Функция для загрузки настроек точки доступа
        function loadAPSettings() {
            fetch('/ap')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    // Заполняем форму настроек AP
                    document.getElementById('ap-mode').value = data.mode;
                    document.getElementById('ap-ssid').value = data.ssid;
                    document.getElementById('ap-password').value = ''; // Пароль не загружаем по соображениям безопасности
                    document.getElementById('ap-channel').value = data.channel;
                    
                    // Отображаем раздел honeypot если выбран соответствующий режим
                    const honeypotSection = document.getElementById('honeypot-section');
                    if (data.mode === 4) {
                        honeypotSection.style.display = 'block';
                        getHoneypotLogs();
                    } else {
                        honeypotSection.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке настроек AP:', error);
                    showNotification('Ошибка при загрузке настроек точки доступа: ' + error.message, 'error');
                });
        }
        
        // Функция для обновления настроек точки доступа
        function updateAPSettings() {
            const formData = new FormData();
            formData.append('mode', document.getElementById('ap-mode').value);
            formData.append('ssid', document.getElementById('ap-ssid').value);
            formData.append('password', document.getElementById('ap-password').value);
            formData.append('channel', document.getElementById('ap-channel').value);
            
            // Показываем уведомление
            showNotification('Обновление настроек точки доступа...', 'info');
            
            fetch('/ap/config', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                showNotification(result, 'success');
                // Обновляем статус
                refreshStatus();
                loadAPSettings();
            })
            .catch(error => {
                console.error('Ошибка при обновлении настроек AP:', error);
                showNotification('Ошибка при обновлении настроек точки доступа: ' + error.message, 'error');
            });
        }
        
        // Функция для получения логов honeypot
        function getHoneypotLogs() {
            fetch('/ap/honeypot/logs')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    const logsDiv = document.getElementById('honeypot-logs');
                    
                    if (data.logs && data.logs.length > 0) {
                        let logsHTML = '<table><tr><th>IP</th><th>Порт</th><th>Время</th><th>Данные</th></tr>';
                        
                        data.logs.forEach(log => {
                            const date = new Date(log.timestamp);
                            logsHTML += `<tr>
                                <td>${log.ip}</td>
                                <td>${log.port}</td>
                                <td>${date.toLocaleString()}</td>
                                <td>${log.data}</td>
                            </tr>`;
                        });
                        
                        logsHTML += '</table>';
                        logsDiv.innerHTML = logsHTML;
                    } else {
                        logsDiv.innerHTML = '<p>Нет записей</p>';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при получении логов honeypot:', error);
                    document.getElementById('honeypot-logs').innerHTML = '<p>Ошибка при загрузке логов</p>';
                    showNotification('Ошибка при получении логов Honeypot: ' + error.message, 'error');
                });
        }
        
        // Функция для загрузки KVM пинов
        function loadKVMPins() {
            const pinsList = document.getElementById('pins-list');
            pinsList.innerHTML = '<p class="text-center">Загрузка пинов...</p>';
            
            fetch('/kvm')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    // Заполняем настройки интервала проверки соединения
                    document.getElementById('connection-check').value = data.connectionCheck;
                    
                    pinsList.innerHTML = '';
                    
                    if (data.pins && data.pins.length > 0) {
                        data.pins.forEach((pin, index) => {
                            const pinCard = document.createElement('div');
                            pinCard.className = 'pin-card';
                            
                            // Информация о пине
                            const pinInfo = document.createElement('div');
                            pinInfo.className = 'pin-info';
                            pinInfo.innerHTML = `<strong>${pin.name}</strong><br>Пин #${pin.pin}`;
                            pinCard.appendChild(pinInfo);
                            
                            // Режим мониторинга
                            const monitorDiv = document.createElement('div');
                            monitorDiv.innerHTML = `
                                <label>Мониторинг:
                                    <select class="monitor-select" data-index="${index}">
                                        <option value="0" ${pin.monitorMode == 0 ? 'selected' : ''}>Выкл</option>
                                        <option value="1" ${pin.monitorMode == 1 ? 'selected' : ''}>Вкл</option>
                                        <option value="2" ${pin.monitorMode == 2 ? 'selected' : ''}>Звук</option>
                                    </select>
                                </label>
                            `;
                            pinCard.appendChild(monitorDiv);
                            
                            // Состояние пина
                            const pinState = document.createElement('div');
                            pinState.className = `pin-state ${pin.state ? 'on' : 'off'}`;
                            
                            // Если режим инвертирован, отображаем обратное состояние
                            if (isPinInverted) {
                                pinState.textContent = pin.state ? 'ВЫКЛ' : 'ВКЛ';
                                pinState.className = `pin-state ${pin.state ? 'off' : 'on'}`;
                            } else {
                                pinState.textContent = pin.state ? 'ВКЛ' : 'ВЫКЛ';
                            }
                            
                            pinCard.appendChild(pinState);
                            
                            // Элементы управления пином
                            const pinControls = document.createElement('div');
                            pinControls.className = 'pin-controls';
                            
                            // Переключатель состояния
                            const toggleContainer = document.createElement('div');
                            toggleContainer.innerHTML = `
                                <label class="toggle-btn">
                                    <input type="checkbox" class="pin-toggle" data-index="${index}" ${pin.state ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            `;
                            pinControls.appendChild(toggleContainer);
                            
                            // Управление импульсом
                            const pulseControl = document.createElement('div');
                            pulseControl.className = 'pulse-control';
                            pulseControl.innerHTML = `
                                <input type="number" id="pin-pulse-duration-${index}" 
                                       class="pulse-duration" 
                                       value="500" 
                                       min="50" 
                                       max="10000" 
                                       placeholder="мс">
                                <button class="pulse-button" 
                                        onclick="sendPulseToPin(${index})"
                                        title="Отправить импульс">
                                    ⚡ Импульс
                                </button>
                            `;
                            pinControls.appendChild(pulseControl);
                            
                            pinCard.appendChild(pinControls);
                            pinsList.appendChild(pinCard);
                        });
                        
                        // Добавляем обработчики событий для переключателей и выпадающих списков
                        document.querySelectorAll('.pin-toggle').forEach(toggle => {
                            toggle.addEventListener('change', function() {
                                const pinIndex = this.getAttribute('data-index');
                                togglePin(pinIndex);
                            });
                        });
                        
                        document.querySelectorAll('.monitor-select').forEach(select => {
                            select.addEventListener('change', function() {
                                const pinIndex = this.getAttribute('data-index');
                                changeMonitorMode(pinIndex, this.value);
                            });
                        });
                    } else {
                        pinsList.innerHTML = '<p class="text-center">Нет настроенных пинов. Добавьте новый пин ниже.</p>';
                    }
                })
                .catch(error => {
                    pinsList.innerHTML = '<p class="text-center">Ошибка при загрузке пинов</p>';
                    console.error('Ошибка при загрузке KVM пинов:', error);
                    showNotification('Ошибка при загрузке KVM пинов: ' + error.message, 'error');
                });
        }
        
        // Функция для изменения режима мониторинга пина
        function changeMonitorMode(pinIndex, mode) {
            const formData = new FormData();
            formData.append('index', pinIndex);
            formData.append('monitor', mode);
            
            fetch('/kvm/pin', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                // Успешно обновлено
                showNotification(`Режим мониторинга пина ${parseInt(pinIndex) + 1} изменен`, 'success');
            })
            .catch(error => {
                console.error('Ошибка при изменении режима мониторинга:', error);
                showNotification('Ошибка при изменении режима мониторинга: ' + error.message, 'error');
                loadKVMPins(); // Перезагружаем пины для восстановления правильного состояния
            });
        }
        
        // Функция для переключения состояния пина
        function togglePin(pinIndex) {
            // Формируем данные для отправки
            const formData = new FormData();
            formData.append('index', pinIndex);
            
            // Отправляем запрос
            fetch('/kvm/pin', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                // Обновляем список пинов
                showNotification(`Состояние пина ${parseInt(pinIndex) + 1} изменено`, 'success');
                loadKVMPins();
            })
            .catch(error => {
                console.error('Ошибка при переключении пина:', error);
                showNotification('Ошибка при переключении пина: ' + error.message, 'error');
                // Обновляем список пинов для отображения текущего состояния
                loadKVMPins();
            });
        }
        
        // Функция для обновления интервала проверки соединения
        function updateConnectionCheck() {
            const interval = document.getElementById('connection-check').value;
            
            fetch('/kvm/connectioncheck', {
                method: 'POST',
                body: new URLSearchParams({
                    'interval': interval
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                showNotification(result, 'success');
            })
            .catch(error => {
                console.error('Ошибка при обновлении интервала проверки:', error);
                showNotification('Ошибка при обновлении интервала проверки: ' + error.message, 'error');
            });
        }
        
        // Функция для добавления нового пина
        function addNewPin() {
            const pinNumber = document.getElementById('pin-select').value;
            const pinName = document.getElementById('pin-name').value;
            
            // Проверки
            if (!pinNumber) {
                showNotification('Выберите пин из списка', 'warning');
                return;
            }
            
            if (!pinName) {
                showNotification('Введите название пина', 'warning');
                return;
            }
            
            // Формируем данные для отправки
            const formData = new FormData();
            formData.append('pin', pinNumber);
            formData.append('name', pinName);
            
            // Отправляем запрос
            fetch('/kvm/add', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.text();
            })
            .then(result => {
                showNotification(result, 'success');
                
                // Очищаем форму
                document.getElementById('pin-select').value = '';
                document.getElementById('pin-name').value = '';
                
                // Обновляем список пинов
                loadKVMPins();
                loadAvailablePins();
            })
            .catch(error => {
                console.error('Ошибка при добавлении пина:', error);
                showNotification('Ошибка: ' + error.message, 'error');
            });
        }
        
        // Функция для загрузки информации об устройстве
        function loadDeviceInfo() {
            const deviceDetails = document.getElementById('device-details');
            deviceDetails.innerHTML = '<p class="text-center">Загрузка информации...</p>';
            
            fetch('/diagnostic')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    let html = '<table>';
                    
                    // Информация о железе и программном обеспечении
                    html += '<tr><th colspan="2">Железо</th></tr>';
                    html += `<tr><td>Модель</td><td>M5StickC PLUS2</td></tr>`;
                    html += `<tr><td>Батарея</td><td>${data.battery ? data.battery.toFixed(2) + 'V' : 'N/A'}</td></tr>`;
                    
                    // Информация о WiFi
                    html += '<tr><th colspan="2">WiFi</th></tr>';
                    if (data.connected) {
                        html += `<tr><td>SSID</td><td>${data.ssid}</td></tr>`;
                        html += `<tr><td>Сигнал</td><td>${data.rssi} dBm</td></tr>`;
                        html += `<tr><td>IP-адрес</td><td>${data.ip}</td></tr>`;
                        html += `<tr><td>Маска подсети</td><td>${data.subnet}</td></tr>`;
                        html += `<tr><td>Шлюз</td><td>${data.gateway}</td></tr>`;
                        html += `<tr><td>DNS</td><td>${data.dns}</td></tr>`;
                    } else {
                        html += `<tr><td colspan="2">Не подключено к WiFi</td></tr>`;
                    }
                    
                    // Информация о точке доступа
                    html += '<tr><th colspan="2">Точка доступа</th></tr>';
                    if (data.ap_mode !== undefined && data.ap_mode > 0) {
                        let apModeName = 'Неизвестно';
                        switch(data.ap_mode) {
                            case 1: apModeName = 'Обычный'; break;
                            case 2: apModeName = 'Ретранслятор'; break;
                            case 3: apModeName = 'Скрытый'; break;
                            case 4: apModeName = 'Honeypot'; break;
                        }
                        
                        html += `<tr><td>Режим</td><td>${apModeName}</td></tr>`;
                        html += `<tr><td>SSID</td><td>${data.ap_ssid}</td></tr>`;
                        html += `<tr><td>IP-адрес</td><td>${data.ap_ip}</td></tr>`;
                        html += `<tr><td>Подключено клиентов</td><td>${data.ap_stations}</td></tr>`;
                    } else {
                        html += `<tr><td colspan="2">Точка доступа выключена</td></tr>`;
                    }
                    
                    html += '</table>';
                    deviceDetails.innerHTML = html;
                })
                .catch(error => {
                    console.error('Ошибка при загрузке информации об устройстве:', error);
                    deviceDetails.innerHTML = '<p class="text-center">Ошибка при загрузке информации</p>';
                    showNotification('Ошибка при загрузке информации об устройстве: ' + error.message, 'error');
                });
        }
        
        // Функция для загрузки настроек устройства
        function loadDeviceSettings() {
            fetch('/device')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('brightness').value = data.brightness;
                    document.getElementById('brightness-value').textContent = data.brightness + '%';
                    
                    document.getElementById('sleep-timeout').value = data.sleepTimeout;
                    document.getElementById('device-id').value = data.deviceId;
                    document.getElementById('rotate-display').checked = data.rotateDisplay;
                    
                    document.getElementById('volume').value = data.volume;
                    document.getElementById('volume-value').textContent = data.volume + '%';
                })
                .catch(error => {
                    console.error('Ошибка при загрузке настроек устройства:', error);
                    showNotification('Ошибка при загрузке настроек устройства: ' + error.message, 'error');
                });
        }
        
        // Функция для сохранения настроек устройства
        function saveDeviceSettings() {
            const formData = new FormData();
            formData.append('brightness', document.getElementById('brightness').value);
            formData.append('sleepTimeout', document.getElementById('sleep-timeout').value);
            formData.append('deviceId', document.getElementById('device-id').value);
            formData.append('rotateDisplay', document.getElementById('rotate-display').checked ? 1 : 0);
            formData.append('volume', document.getElementById('volume').value);
            
            fetch('/device/settings', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                showNotification('Настройки устройства сохранены', 'success');
            })
            .catch(error => {
                console.error('Ошибка при сохранении настроек устройства:', error);
                showNotification('Ошибка при сохранении настроек устройства: ' + error.message, 'error');
            });
        }
        
        // Функция активации звукового сигнала "Найти меня"
        function findMe() {
            fetch('/device/findme', {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                showNotification('Звуковой сигнал активирован', 'success');
            })
            .catch(error => {
                console.error('Ошибка при активации сигнала:', error);
                showNotification('Ошибка при активации сигнала: ' + error.message, 'error');
            });
        }
        
        // Функция перезагрузки устройства
        function resetDevice() {
            if (confirm('Вы уверены, что хотите перезагрузить устройство?')) {
                fetch('/device/reset', {
                    method: 'POST'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.text();
                })
                .then(result => {
                    showNotification('Устройство перезагружается...', 'info');
                    // Таймер для обновления страницы после перезагрузки устройства
                    setTimeout(() => {
                        window.location.reload();
                    }, 10000);
                })
                .catch(error => {
                    console.error('Ошибка при перезагрузке устройства:', error);
                    showNotification('Ошибка при перезагрузке устройства: ' + error.message, 'error');
                });
            }
        }
        
        // Проверка доступности сетевых инструментов
        function checkNetworkTools() {
            if (!isAPModeActive) {
                document.getElementById('ip-block-section').style.display = 'none';
            } else {
                document.getElementById('ip-block-section').style.display = 'block';
                loadBlockedIPs();
            }
        }
        
        // Загрузка списка заблокированных IP
        function loadBlockedIPs() {
            fetch('/network/blocked')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    const blockedIPsDiv = document.getElementById('blocked-ips');
                    
                    if (data.blocked && data.blocked.length > 0) {
                        let html = '<ul>';
                        data.blocked.forEach(ip => {
                            html += `<li>${ip} <button class="danger" onclick="unblockIP('${ip}')">Разблокировать</button></li>`;
                        });
                        html += '</ul>';
                        blockedIPsDiv.innerHTML = html;
                    } else {
                        blockedIPsDiv.innerHTML = '<p>Нет заблокированных IP-адресов</p>';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке списка заблокированных IP:', error);
                    document.getElementById('blocked-ips').innerHTML = '<p>Ошибка при загрузке списка заблокированных IP</p>';
                });
        }
        
        // Функция для выполнения Ping
        function pingHost() {
            const host = document.getElementById('ping-host').value;
            
            if (!host) {
                showNotification('Введите хост для Ping', 'warning');
                return;
            }
            
            const resultDiv = document.getElementById('ping-result');
            resultDiv.innerHTML = '<div class="loader" style="display: block;"></div>';
            
            fetch('/network/ping', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `host=${encodeURIComponent(host)}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => {
                let resultHTML = '<div class="status info">';
                
                if (data.success) {
                    resultHTML += `<p>Ping к ${host} успешен</p>`;
                    resultHTML += `<p>IP: ${data.ip}</p>`;
                    resultHTML += `<p>Среднее время: ${data.time} мс</p>`;
                    resultHTML += `<p>Потеря пакетов: ${data.loss}%</p>`;
                } else {
                    resultHTML += `<p>Ошибка при выполнении ping к ${host}</p>`;
                    if (data.error) {
                        resultHTML += `<p>Ошибка: ${data.error}</p>`;
                    }
                }
                
                resultHTML += '</div>';
                resultDiv.innerHTML = resultHTML;
            })
            .catch(error => {
                console.error('Ошибка при выполнении ping:', error);
                resultDiv.innerHTML = `
                    <div class="status error">
                        <p>Ошибка при выполнении ping: ${error.message}</p>
                    </div>
                `;
            });
        }
        
        // Функция для сканирования диапазона IP
        function scanIPRange() {
            const prefix = document.getElementById('ip-prefix').value;
            
            if (!prefix) {
                showNotification('Введите префикс сети для сканирования', 'warning');
                return;
            }
            
            const progressDiv = document.getElementById('ip-scan-progress');
            const progressBar = document.getElementById('ip-scan-progress-bar');
            const progressStatus = document.getElementById('ip-scan-status');
            const resultDiv = document.getElementById('ip-scan-result');
            
            progressDiv.style.display = 'block';
            resultDiv.innerHTML = 'Сканирование...';
            
            let currentIP = 1;
            const totalIPs = 254;
            const results = [];
            
            function scanNext() {
                if (currentIP > totalIPs) {
                    // Завершение сканирования
                    progressDiv.style.display = 'none';
                    displayScanResults(results);
                    return;
                }
                
                const progress = (currentIP / totalIPs) * 100;
                progressBar.style.width = `${progress}%`;
                progressStatus.textContent = `Сканирование: ${currentIP}/${totalIPs}`;
                
                // Сканируем текущий IP
                fetch('/network/scan-single', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `ip=${encodeURIComponent(prefix + '.' + currentIP)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.active) {
                        results.push({
                            ip: prefix + '.' + currentIP,
                            active: true,
                            time: data.time
                        });
                    }
                    currentIP++;
                    // Переходим к следующему IP
                    setTimeout(scanNext, 100); // Задержка для предотвращения перегрузки
                })
                .catch(error => {
                    console.error('Ошибка при сканировании IP:', error);
                    currentIP++;
                    setTimeout(scanNext, 100);
                });
            }
            
            // Начинаем сканирование
            scanNext();
        }
        
        function displayScanResults(results) {
            const resultDiv = document.getElementById('ip-scan-result');
            let resultHTML = '';
            
            if (results.length > 0) {
                resultHTML = '<table><tr><th>IP-адрес</th><th>Статус</th><th>Время отклика</th></tr>';
                
                results.forEach(host => {
                    resultHTML += `<tr>
                        <td>${host.ip}</td>
                        <td><span class="badge success">Активен</span></td>
                        <td>${host.time ? host.time + ' мс' : '-'}</td>
                    </tr>`;
                });
                
                resultHTML += '</table>';
            } else {
                resultHTML = '<div class="status warning"><p>Активные хосты не найдены</p></div>';
            }
            
            resultDiv.innerHTML = resultHTML;
        }
        
        // Функция для сканирования портов
        function scanPorts() {
            const ip = document.getElementById('port-scan-ip').value;
            const startPort = document.getElementById('port-scan-start').value;
            const endPort = document.getElementById('port-scan-end').value;
            
            if (!ip) {
                showNotification('Введите IP-адрес для сканирования портов', 'warning');
                return;
            }
            
            const resultDiv = document.getElementById('port-scan-result');
            resultDiv.innerHTML = '<div class="loader" style="display: block;"></div>';
            
            fetch('/network/portscan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ip=${encodeURIComponent(ip)}&startPort=${startPort}&endPort=${endPort}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => {
                let resultHTML = '';
                
                if (data.success) {
                    if (data.ports && data.ports.length > 0) {
                        resultHTML = `<div class="status success"><p>Сканирование портов для ${ip} завершено. Найдено открытых портов: ${data.ports.length}</p></div>`;
                        resultHTML += '<table><tr><th>Порт</th><th>Статус</th><th>Сервис</th></tr>';
                        
                        data.ports.forEach(port => {
                            resultHTML += `<tr>
                                <td>${port.port}</td>
                                <td><span class="badge success">Открыт</span></td>
                                <td>${port.service || 'Неизвестно'}</td>
                            </tr>`;
                        });
                        
                        resultHTML += '</table>';
                    } else {
                        resultHTML = `<div class="status warning"><p>Открытые порты не найдены для ${ip}</p></div>`;
                    }
                } else {
                    resultHTML = `<div class="status error"><p>Ошибка при сканировании портов: ${data.error || 'Неизвестная ошибка'}</p></div>`;
                }
                
                resultDiv.innerHTML = resultHTML;
            })
            .catch(error => {
                console.error('Ошибка при сканировании портов:', error);
                resultDiv.innerHTML = `
                    <div class="status error">
                        <p>Ошибка при сканировании портов: ${error.message}</p>
                    </div>
                `;
            });
        }
        
        // Функция для блокировки IP
        function blockIP() {
            const ip = document.getElementById('block-ip').value;
            
            if (!ip) {
                showNotification('Введите IP-адрес для блокировки', 'warning');
                return;
            }
            
            if (!isAPModeActive) {
                showNotification('Блокировка IP доступна только в режиме точки доступа', 'warning');
                return;
            }
            
            fetch('/network/block', {
                method: 'POST',
                body: new URLSearchParams({
                    'ip': ip
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                showNotification(`IP-адрес ${ip} заблокирован`, 'success');
                loadBlockedIPs();
            })
            .catch(error => {
                console.error('Ошибка при блокировке IP:', error);
                showNotification('Ошибка при блокировке IP: ' + error.message, 'error');
            });
        }
        
        // Функция для разблокировки IP
        function unblockIP(ip) {
            if (!isAPModeActive) {
                showNotification('Разблокировка IP доступна только в режиме точки доступа', 'warning');
                return;
            }
            
            fetch('/network/unblock', {
                method: 'POST',
                body: new URLSearchParams({
                    'ip': ip
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(result => {
                showNotification(`IP-адрес ${ip} разблокирован`, 'success');
                loadBlockedIPs();
            })
            .catch(error => {
                console.error('Ошибка при разблокировке IP:', error);
                showNotification('Ошибка при разблокировке IP: ' + error.message, 'error');
            });
        }
        
        // Функция для загрузки списка пользователей AP
        function loadAPUsers() {
            const usersList = document.getElementById('ap-users-list');
            
            if (!isAPModeActive) {
                usersList.innerHTML = '<p class="text-center">Точка доступа не активна</p>';
                return;
            }
            
            usersList.innerHTML = '<p class="text-center">Загрузка списка пользователей...</p>';
            
            fetch('/ap/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.users && data.users.length > 0) {
                        let html = '';
                        
                        data.users.forEach(user => {
                            html += `
                                <div class="ap-user-card" id="user-${user.ip.replace(/\./g, '-')}">
                                    <div class="ap-user-info">
                                        <h4>${user.ip}</h4>
                                        <div>MAC: ${user.mac}</div>
                                        <div>Общий трафик: ${user.totalBytes} байт</div>
                                        <div>Последняя активность: ${new Date(user.lastSeen).toLocaleString()}</div>
                                    </div>
                                    <div class="ap-user-controls">
                                        <button class="primary" onclick="showUserDetails('${user.ip}')">Подробнее</button>
                                        <button class="${user.blocked ? 'success' : 'danger'}" 
                                                onclick="toggleUserBlock('${user.ip}', ${!user.blocked})">
                                            ${user.blocked ? 'Разблокировать' : 'Заблокировать'}
                                        </button>
                                    </div>
                                </div>
                                <div id="user-details-${user.ip.replace(/\./g, '-')}" class="user-details-section hidden">
                                    <div>
                                        <h5>Информация о пользователе</h5>
                                        <table>
                                            <tr><td>IP:</td><td>${user.ip}</td></tr>
                                            <tr><td>MAC:</td><td>${user.mac}</td></tr>
                                            <tr><td>Общий трафик:</td><td>${user.totalBytes} байт</td></tr>
                                            <tr><td>Последняя активность:</td><td>${new Date(user.lastSeen).toLocaleString()}</td></tr>
                                            <tr><td>Статус:</td><td>${user.blocked ? 'Заблокирован' : 'Активен'}</td></tr>
                                        </table>
                                    </div>
                                    <div>
                                        <h5>Трафик</h5>
                                        <button class="primary" onclick="startSniffing('${user.ip}')">Начать сниффинг</button>
                                        <button class="danger" onclick="stopSniffing()">Остановить сниффинг</button>
                                        <div id="traffic-display-${user.ip.replace(/\./g, '-')}" class="traffic-display"></div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        usersList.innerHTML = html;
                    } else {
                        usersList.innerHTML = '<p class="text-center">Нет подключенных пользователей</p>';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке списка пользователей:', error);
                    usersList.innerHTML = '<p class="text-center">Ошибка при загрузке списка пользователей</p>';
                    showNotification('Ошибка при загрузке списка пользователей: ' + error.message, 'error');
                });
        }
        
        // Функция для показа деталей пользователя
        function showUserDetails(ip) {
            const detailsDiv = document.getElementById(`user-details-${ip.replace(/\./g, '-')}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('hidden');
            }
        }
        
        // Функция для переключения блокировки пользователя
        function toggleUserBlock(ip, block) {
            fetch('/ap/users/block', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ip=${encodeURIComponent(ip)}&blocked=${block ? 1 : 0}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showNotification(`Пользователь ${ip} ${block ? 'заблокирован' : 'разблокирован'}`, 'success');
                    loadAPUsers();
                } else {
                    showNotification(`Ошибка: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при изменении блокировки пользователя:', error);
                showNotification('Ошибка при изменении блокировки пользователя: ' + error.message, 'error');
            });
        }
        
        // Функция для начала сниффинга трафика
        function startSniffing(ip) {
            currentUserIP = ip;
            const trafficDisplay = document.getElementById(`traffic-display-${ip.replace(/\./g, '-')}`);
            
            if (trafficDisplay) {
                trafficDisplay.innerHTML = '<p>Запуск сниффинга...</p>';
            }
            
            // Отправляем запрос на запуск сниффинга
            fetch('/ap/users/sniff', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ip=${encodeURIComponent(ip)}&action=start`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Сниффинг запущен', 'success');
                    // Начинаем периодическое обновление трафика
                    sniffInterval = setInterval(() => {
                        fetch(`/ap/users/traffic?ip=${encodeURIComponent(ip)}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Ошибка сети');
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (trafficDisplay) {
                                    let displayHtml = `
                                        <div><strong>Общий трафик:</strong> ${data.totalBytes} байт</div>
                                        <div><strong>Последний пакет:</strong> ${data.lastPacket || 'Нет данных'}</div>
                                        <div><strong>Обновлено:</strong> ${new Date().toLocaleTimeString()}</div>
                                    `;
                                    
                                    if (data.sniffing && data.lastPacketInfo) {
                                        displayHtml += `
                                            <div class="divider"></div>
                                            <div><strong>Сниффинг активен</strong></div>
                                            <div><strong>Перехвачено пакетов:</strong> ${data.sniffedPackets}</div>
                                            <div><strong>Информация о пакете:</strong> ${data.lastPacketInfo}</div>
                                        `;
                                    }
                                    
                                    trafficDisplay.innerHTML = displayHtml;
                                }
                            })
                            .catch(error => {
                                console.error('Ошибка при получении трафика:', error);
                                if (sniffInterval) {
                                    clearInterval(sniffInterval);
                                    sniffInterval = null;
                                }
                                showNotification('Ошибка при получении трафика: ' + error.message, 'error');
                            });
                    }, 1000); // Обновляем каждую секунду
                } else {
                    showNotification(`Ошибка запуска сниффинга: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при запуске сниффинга:', error);
                showNotification('Ошибка при запуске сниффинга: ' + error.message, 'error');
            });
        }
        
        // Функция для остановки сниффинга трафика
        function stopSniffing() {
            if (sniffInterval) {
                clearInterval(sniffInterval);
                sniffInterval = null;
            }
            
            if (currentUserIP) {
                // Отправляем запрос на остановку сниффинга
                fetch('/ap/users/sniff', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `ip=${encodeURIComponent(currentUserIP)}&action=stop`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Сниффинг остановлен', 'success');
                        const trafficDisplay = document.getElementById(`traffic-display-${currentUserIP.replace(/\./g, '-')}`);
                        if (trafficDisplay) {
                            trafficDisplay.innerHTML = '<p>Сниффинг остановлен</p>';
                        }
                    } else {
                        showNotification(`Ошибка остановки сниффинга: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Ошибка при остановке сниффинга:', error);
                    showNotification('Ошибка при остановке сниффинга: ' + error.message, 'error');
                });
                
                currentUserIP = null;
            }
        }
    </script>
</body>
</html>